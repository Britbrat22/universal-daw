<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>miniDAW ‚Äì fixed selectors</title>
<style>
:root{--bg:#0b0b0b;--panel:#151515;--accent:#4ecdc4;--danger:#ff6b6b;--text:#fff;--sub:#888;--border:#222;}
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,sans-serif;}
body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100vh;overflow:hidden;}
header{padding:6px;background:#161616;display:flex;gap:6px;flex-wrap:wrap;align-items:center;user-select:none;}
button{background:var(--accent);border:none;padding:6px 10px;border-radius:4px;color:#000;font-weight:bold;cursor:pointer;}
button:hover{filter:brightness(1.15);}button:active{transform:scale(.97);}
main{display:flex;flex:1;min-height:0;}
.left{width:260px;background:var(--panel);padding:8px;overflow-y:scroll;border-right:1px solid var(--border);}
.timeline-wrap{flex:1;display:flex;flex-direction:column;}
.timeline-header{height:28px;background:#161616;border-bottom:1px solid var(--border);position:relative;}
.timeline-ruler{position:absolute;height:100%;left:0;top:0;font-size:10px;color:var(--sub);cursor:pointer;}
.timeline-body{flex:1;overflow:auto;background:#111;}
.track-lane{height:100px;border-bottom:1px solid var(--border);position:relative;display:flex;align-items:center;}
.wave-canvas{width:100%;height:100%;cursor:crosshair;}
.playhead-line{position:absolute;top:0;bottom:0;width:2px;background:var(--danger);pointer-events:none;z-index:3;}
.drop-here{border:2px dashed #444;border-radius:6px;padding:20px;text-align:center;font-size:12px;color:var(--sub);margin-bottom:8px;}
.fader{width:100%;margin:3px 0;}
.small{font-size:10px;color:var(--sub);}
.history{max-height:100px;overflow-y:auto;font-size:10px;}
.chat-wrap{display:flex;gap:4px;}
.chat-box{flex:1;height:100px;background:#000;border:1px solid #333;border-radius:4px;font-size:10px;overflow-y:auto;padding:4px;}
.chat-input{flex:1;font-size:10px;padding:4px;border:1px solid #333;border-radius:4px;background:#111;color:#fff;}
footer{padding:6px;background:#161616;}
#unlockScreen{position:fixed;inset:0;background:#111;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;z-index:1000;}
#unlockScreen button{padding:12px 24px;font-size:16px;}
#unlockDrop{border:2px dashed #555;border-radius:8px;padding:40px;max-width:500px;text-align:center;color:#888;}
</style>
</head>
<body>

<!-- UNLOCK -->
<div id="unlockScreen">
  <button id="unlockBtn">Unlock & Upload</button>
  <div id="unlockDrop">Drop files here</div>
  <input type="file" id="unlockInput" multiple accept="audio/*,.mid,.midi" hidden>
</div>

<!-- DAW -->
<div id="dawPage" style="display:none;flex-direction:column;height:100vh">
<header>
  <div class="drop-here" id="dropZone">Drop audio / MIDI files here</div>
  <button id="playBtn">‚ñ∂Ô∏è Play</button><button id="stopBtn">‚èπÔ∏è Stop</button><button id="loopBtn">üîÅ Loop</button>
  <button onclick="splitAtPlayhead()">‚úÇÔ∏è Split</button><button onclick="copyClip()">üìã Copy</button><button onclick="pasteClip()">üì• Paste</button><button onclick="deleteClip()">üóëÔ∏è Delete</button>
  <button onclick="zoomIn()">Zoom In</button><button onclick="zoomOut()">Zoom Out</button><button onclick="exportMix()">üíæ Export Mix</button>
  <input type="file" id="fileInput" multiple accept="audio/*,.mid,.midi" hidden>
</header>

<main>
<div class="left">
  <section><h3>Track Controls</h3><div id="trackPanel"></div></section>
  <section>
    <h3>Master FX</h3>
    <label>Reverb</label><input class="fader" id="revRange" type="range" min="0" max="100" value="0">
    <label>Comp</label><input class="fader" id="compRange" type="range" min="0" max="100" value="0">
  </section>
  <section>
    <h3>Collab Chat</h3>
    <div class="chat-box" id="chatLog">Chat ready‚Ä¶</div>
    <div class="chat-wrap">
      <input class="chat-input" id="chatInput" placeholder="Type‚Ä¶">
      <button onclick="sendChat()">Send</button>
    </div>
  </section>
  <section><h3>History</h3><div id="history" class="history">No edits yet</div><button onclick="undoLast()">‚Ü∂ Undo</button></section>
</div>

<div class="timeline-wrap">
  <div class="timeline-header"><div class="timeline-ruler" id="ruler"></div><div class="playhead-line" id="playhead"></div></div>
  <div class="timeline-body" id="timeline"></div>
</div>
</div>

<footer id="status">Ready ‚Äì drop files to start</footer>

<script>
/* ===== AUDIO ===== */
const ctx=new (window.AudioContext||window.webkitAudioContext)();
const masterGain=ctx.createGain();
const masterComp=ctx.createDynamicsCompressor();
masterComp.threshold.value=-30;masterComp.knee.value=40;masterComp.ratio.value=12;masterComp.attack.value=0;masterComp.release.value=0.25;
let reverbGain=ctx.createGain();reverbGain.gain.value=0; // OFF by default
const masterDelay=ctx.createDelay(1);
masterGain.connect(masterComp).connect(reverbGain).connect(masterDelay).connect(ctx.destination);
buildImpulse();
function buildImpulse(){
  const len=ctx.sampleRate*2,buf=ctx.createBuffer(2,len,ctx.sampleRate);
  for(let c=0;c<2;c++) for(let i=0;i<len;i++) buf.getChannelData(c)[i]=(Math.random()*2-1)*Math.pow(1-i/len,2);
  const rev=ctx.createConvolver();rev.buffer=buf;reverbGain.connect(rev).connect(masterDelay);
}
document.getElementById('revRange').oninput=e=>reverbGain.gain.value=e.target.value/100;
document.getElementById('compRange').oninput=e=>masterComp.threshold.value=-40+e.target.value/100*30;

/* ===== STATE ===== */
const tracks=[];let playhead=0,zoom=1,isPlaying=false,loop=false,playInterval;
function status(s){document.getElementById('status').innerText=s;}
function addH(s){document.getElementById('history').innerHTML+=s+'<br>';}

/* ===== UNLOCK ===== */
const unlockScreen=document.getElementById('unlockScreen');
const unlockBtn=document.getElementById('unlockBtn');
const unlockInput=document.getElementById('unlockInput');
const unlockDrop=document.getElementById('unlockDrop');
unlockBtn.onclick=()=>ctx.resume().then(()=>unlockInput.click());
unlockDrop.onclick=()=>unlockInput.click();
unlockDrop.ondragover=e=>{e.preventDefault();unlockDrop.style.borderColor='#4ecdc4';};
unlockDrop.ondrop=async e=>{e.preventDefault();unlockDrop.style.borderColor='#555';await addFiles([...e.dataTransfer.files]);};
unlockInput.onchange=async e=>await addFiles([...e.target.files]);

/* ===== FILES ===== */
async function addFiles(files){
  for(const f of files){
    const buf=await f.arrayBuffer();
    if(f.name.endsWith('.mid')||f.name.endsWith('.midi')){
      const notes=await midiToNotes(buf);
      const id=Date.now()+Math.random();
      tracks.push({name:f.name,buffer:null,gain:ctx.createGain(),pan:ctx.createStereoPanner(),mute:false,solo:false,id,clips:[],type:'midi',notes});
      makeMidiLane(id);
    }else{
      const audioBuf=await ctx.decodeAudioData(buf);
      const id=Date.now()+Math.random();
      const clip={start:0,end:audioBuf.duration,buffer:audioBuf};
      tracks.push({name:f.name,buffer:audioBuf,gain:ctx.createGain(),pan:ctx.createStereoPanner(),mute:false,solo:false,id,clips:[clip],type:'audio'});
      makeAudioLane(id);
    }
    addH('Added: '+f.name);
  }
  if(unlockScreen.style.display!=='none'){unlockScreen.style.display='none';document.getElementById('dawPage').style.display='flex';}
  renderRuler();buildPanel();status(tracks.length+' file(s) loaded');
}
async function midiToNotes(){return[{pitch:60,velocity:100,start:0,end:.5},{pitch:64,velocity:90,start:.5,end:1},{pitch:67,velocity:80,start:1,end:1.5}];}

/* ===== TRANSPORT ===== */
document.getElementById('playBtn').onclick=playAll;
document.getElementById('stopBtn').onclick=stopAll;
document.getElementById('loopBtn').onclick=()=>{loop=!loop;status(loop?'Loop ON':'Loop OFF');};
document.body.onkeydown=e=>{if(e.code==='Space'){e.preventDefault();isPlaying?stopAll():playAll();}};

function playAll(){
  if(isPlaying)return;
  isPlaying=true;
  playInterval=setInterval(()=>{playhead+=.01;updatePlayhead();if(loop&&playhead>getMaxDur())playhead=0;},10);
  tracks.forEach(playTrack);
  status('Playing');
}
function stopAll(){
  isPlaying=false;clearInterval(playInterval);
  tracks.forEach(t=>{if(t.source){t.source.stop();t.source=null;}});
  playhead=0;updatePlayhead();status('Stopped');
}
function updatePlayhead(){
  const maxDur=getMaxDur(),px=maxDur?document.getElementById('ruler').clientWidth*(playhead/maxDur):0;
  document.getElementById('playhead').style.left=px+'px';
}
function getMaxDur(){return tracks.reduce((m,t)=>{if(t.type==='audio')return Math.max(m,...t.clips.map(c=>c.end));if(t.type==='midi')return Math.max(m,...t.notes.map(n=>n.end));return m;},0)||1;}

function playTrack(t){
  if(t.mute||(tracks.some(x=>x.solo)&&!t.solo))return;
  if(t.type==='audio'&&t.buffer){
    t.source=ctx.createBufferSource();
    t.source.buffer=t.buffer;
    t.source.connect(t.gain).connect(t.pan).connect(masterGain);
    const offset=playhead;
    const dur=t.buffer.duration-offset;
    if(dur>0)t.source.start(0,offset,dur);
  }
}

/* ===== UI ===== */
function renderRuler(){
  const ruler=document.getElementById('ruler');
  ruler.innerHTML='';
  const dur=getMaxDur(),px=dur?ruler.clientWidth/dur:0;
  for(let i=0;i<=dur;i++){
    const t=document.createElement('div');
    t.style.position='absolute';t.style.left=(i*px)+'px';t.style.top='0';t.style.width='1px';t.style.height='100%';t.style.background='#888';
    t.innerHTML='<span style="margin-left:2px;font-size:10px">'+i+'s</span>';
    ruler.appendChild(t);
  }
  ruler.onclick=e=>{const d=getMaxDur();if(d)playhead=(e.offsetX/ruler.clientWidth)*d;updatePlayhead();};
}
function makeAudioLane(id){
  const lane=document.createElement('div');lane.className='track-lane';lane.id='lane_'+id;
  const c=document.createElement('canvas');c.className='wave-canvas';
  lane.appendChild(c);document.getElementById('timeline').appendChild(lane);
  drawWave(c,tracks.find(t=>t.id===id));
}
function makeMidiLane(id){
  const lane=document.createElement('div');lane.className='track-lane';lane.id='lane_'+id;
  const c=document.createElement('canvas');c.className='midi-canvas';
  lane.appendChild(c);document.getElementById('timeline').appendChild(lane);
}
function drawWave(canvas,track){
  if(!track.buffer)return;
  const w=canvas.width=canvas.offsetWidth*2,height=canvas.height=canvas.offsetHeight;
  const ctx=canvas.getContext('2d'),data=track.buffer.getChannelData(0),step=data.length/w;
  ctx.fillStyle='#4ecdc4';
  for(let i=0;i<w;i++){
    const start=Math.floor(i*step),end=Math.floor((i+1)*step);
    let min=0,max=0;
    for(let j=start;j<end;j++){const v=data[j];if(v<min)min=v;if(v>max)max=v;}
    ctx.fillRect(i,(1+min)*height/2,1,(max-min)*height/2);
  }
}
function buildPanel(){
  const p=document.getElementById('trackPanel');p.innerHTML='';
  tracks.forEach(t=>{
    const d=document.createElement('div');d.className='track-controls';
    d.innerHTML=`
      <h4>${t.name}</h4>
      <button class="danger" onclick="muteTrack('${t.id}')">${t.mute?'üîá':'üîä'}</button>
      <button onclick="soloTrack('${t.id}')">${t.solo?'Solo':'Unsolo'}</button>
      <label>Vol</label><input class="fader" type="range" min="0" max="100" value="75" oninput="setVol('${t.id}',this.value)">
      <label>Pan</label><input class="fader" type="range" min="-100" max="100" value="0" oninput="setPan('${t.id}',this.value)">
    `;
    p.appendChild(d);
  });
}
// ----- SAFE LOOKUPS (no querySelector) -----
function muteTrack(id){const t=tracks.find(x=>x.id===id);if(!t)return;t.mute=!t.mute;buildPanel();}
function soloTrack(id){const t=tracks.find(x=>x.id===id);if(!t)return;t.solo=!t.solo;buildPanel();}
function setVol(id,v){const t=tracks.find(x=>x.id===id);if(!t)return;t.gain.gain.value=v/100;}
function setPan(id,v){const t=tracks.find(x=>x.id===id);if(!t)return;t.pan.pan.value=v/100;}

/* ===== CHAT ===== */
function sendChat(){
  const inp=document.getElementById('chatInput'),log=document.getElementById('chatLog');
  if(!inp.value.trim())return;
  log.innerHTML+='<div><b>You:</b> '+inp.value+'</div>';
  log.scrollTop=log.scrollHeight;
  inp.value='';
}
document.getElementById('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter')sendChat();});

/* ===== ZOOM (no bad selectors) ===== */
function zoomIn(){zoom*=1.2;renderRuler();tracks.forEach(t=>{if(t.type==='audio'){const c=document.getElementById('lane_'+t.id)?.querySelector('.wave-canvas');if(c)drawWave(c,t);}});}
function zoomOut(){zoom/=1.2;renderRuler();tracks.forEach(t=>{if(t.type==='audio'){const c=document.getElementById('lane_'+t.id)?.querySelector('.wave-canvas');if(c)drawWave(c,t);}});}

/* ===== STUBS ===== */
function splitAtPlayhead(){}function copyClip(){}function pasteClip(){}function deleteClip(){}function exportMix(){}function undoLast(){}

/* ===== DROP IN DAW ===== */
const dz=document.getElementById('dropZone');
dz.onclick=()=>document.getElementById('fileInput').click();
dz.ondragover=e=>{e.preventDefault();dz.style.borderColor='#4ecdc4';};
dz.ondrop=async e=>{e.preventDefault();dz.style.borderColor='#444';await addFiles([...e.dataTransfer.files]);};
document.getElementById('fileInput').onchange=async e=>await addFiles([...e.target.files]);

window.onload=()=>status('Press Unlock & Upload');
</script>
</body>
</html>
