<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BandLab-Style AI DAW</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --bg:#0b0b0b;--panel:#151515;--accent:#4ecdc4;--danger:#ff6b6b;--text:#fff;--sub:#aaa;--border:#222;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,sans-serif;}
body{
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* HEADER */
header{
  padding:8px;
  background:#161616;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  align-items:center;
  position:sticky;
  top:0;
  z-index:10;
}
button{
  background:var(--accent);
  border:none;
  padding:6px 10px;
  border-radius:4px;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}
button.danger{background:var(--danger);}

/* MAIN DAW */
#dawPage{
  display:none;
  flex-direction:column;
  flex:1 1 auto;
  min-height:0;
}
main{
  display:flex;
  flex:1 1 auto;
  min-height:0;
  overflow:hidden;
}
.left{
  flex:0 0 260px;
  background:var(--panel);
  padding:8px;
  overflow-y:auto;
  min-height:0;
  border-right:1px solid var(--border);
}
.timeline-wrap{
  flex:1 1 auto;
  display:flex;
  flex-direction:column;
  min-height:0;
  overflow:hidden;
}
.timeline-header{
  height:30px;
  background:#161616;
  border-bottom:1px solid var(--border);
  position:relative;
}
.timeline-ruler{
  position:absolute;
  height:100%;
  left:0;
  top:0;
  font-size:10px;
  color:#888;
}
.timeline-body{
  flex:1 1 auto;
  overflow-y:auto;
  min-height:0;
}
.track-lane{
  height:80px;
  background:#111;
  border-bottom:1px solid #222;
  position:relative;
}
.wave-canvas,.midi-canvas{
  width:100%;
  height:100%;
  cursor:pointer;
}
.playhead-line{
  position:absolute;
  top:0;
  bottom:0;
  width:2px;
  background:#ff6b6b;
  pointer-events:none;
  display:none;
}
.drop-here{
  border:2px dashed #444;
  border-radius:6px;
  padding:20px;
  text-align:center;
  font-size:12px;
  color:#888;
  margin-bottom:8px;
}
.fader{width:100%;margin:3px 0;}
.small{font-size:10px;color:#888;}
.history{max-height:100px;overflow-y:auto;font-size:10px;}
.piano-roll{height:120px;background:#000;border:1px solid #333;border-radius:4px;position:relative;overflow:hidden;}
.piano-key{position:absolute;background:#ccc;border:1px solid #999;width:20px;height:10px;font-size:8px;color:#000;text-align:center;line-height:10px;}
.loop-lib{background:rgba(0,0,0,.3);padding:6px;border-radius:4px;font-size:10px;margin-top:4px;}
.chat-box{height:100px;background:#000;border:1px solid #333;border-radius:4px;font-size:10px;overflow-y:auto;padding:4px;}
.chat-input{width:100%;margin-top:4px;font-size:10px;padding:4px;border:1px solid #333;border-radius:4px;background:#111;color:#fff;}
footer{padding:6px;background:#161616;position:sticky;bottom:0;z-index:5;}

/* UNLOCK SCREEN */
#unlockScreen{
  position:fixed;
  inset:0;
  background:#111;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:20px;
  z-index:1000;
}
#unlockScreen button{
  padding:12px 24px;
  font-size:16px;
}
#unlockDrop{
  border:2px dashed #555;
  border-radius:8px;
  padding:40px;
  max-width:500px;
  text-align:center;
  color:#888;
  cursor:pointer;
}
</style>
</head>
<body>

<!-- UNLOCK SCREEN -->
<div id="unlockScreen">
  <button id="unlockBtn">Unlock & Upload</button>
  <div id="unlockDrop">Drop files here or click "Unlock & Upload"</div>
  <input type="file" id="unlockInput" multiple accept="audio/*,.mid,.midi" style="display:none">
</div>

<!-- DAW PAGE -->
<div id="dawPage" style="flex:1 1 auto; display:flex; flex-direction:column;">
<header>
  <div class="drop-here" id="dropZone">Drop audio / MIDI files here (or click)</div>
  <button onclick="playAll()">‚ñ∂Ô∏è Play</button>
  <button onclick="stopAll()">‚èπÔ∏è Stop</button>
  <button onclick="loopToggle()">üîÅ Loop</button>
  <button onclick="splitAtPlayhead()">‚úÇÔ∏è Split</button>
  <button onclick="copyClip()">üìã Copy</button>
  <button onclick="pasteClip()">üì• Paste</button>
  <button onclick="deleteClip()">üóëÔ∏è Delete</button>
  <button onclick="zoomIn()">Zoom In</button>
  <button onclick="zoomOut()">Zoom Out</button>
  <button onclick="exportMix()">üíæ Export Mix</button>
  <input type="file" id="fileInput" multiple accept="audio/*,.mid,.midi" hidden>
</header>

<main>
<div class="left">
  <section>
    <h3>AI Tools</h3>
    <button onclick="aiBeatGen()">ü•Å Generate Beat</button>
    <button onclick="aiVocalClean()">üé§ Clean Vocals</button>
    <button onclick="aiAlignVocals()">üîó Align Vocals</button>
    <button onclick="aiWriteLyrics()">üìù AI Lyrics</button>
  </section>
  <section>
    <h3>MIDI / Piano</h3>
    <button onclick="addMidiTrack()">‚ûï Add MIDI Track</button>
    <div class="piano-roll" id="piano"></div>
  </section>
  <section>
    <h3>Loop Library</h3>
    <button onclick="addLoop('kick')">Kick</button>
    <button onclick="addLoop('hat')">Hat</button>
    <button onclick="addLoop('snare')">Snare</button>
    <div class="loop-lib" id="loopLib">Drop loops here</div>
  </section>
  <section>
    <h3>Master FX</h3>
    <label>Reverb</label><input class="fader" id="masterReverb" type="range" min="0" max="100" value="0">
    <label>Delay</label><input class="fader" id="masterDelay" type="range" min="0" max="100" value="0">
    <label>Compression</label><input class="fader" id="masterComp" type="range" min="0" max="100" value="0">
  </section>
  <section>
    <h3>Collab Chat</h3>
    <div class="chat-box" id="chatLog">Chat ready‚Ä¶</div>
    <input class="chat-input" id="chatInput" placeholder="Type message‚Ä¶" onkeypress="if(event.key==='Enter')sendChat()">
  </section>
  <section>
    <h3>History</h3>
    <div id="history" class="history">No edits yet</div>
    <button onclick="undoLast()">‚Ü∂ Undo</button>
  </section>
</div>

<div class="timeline-wrap">
  <div class="timeline-header">
    <div class="timeline-ruler" id="ruler"></div>
    <div class="playhead-line" id="playhead"></div>
  </div>
  <div class="timeline-body" id="timeline"></div>
</div>
</main>

<footer id="status">Ready ‚Äì drop audio / MIDI files to start</footer>
</div>

<script>
/* ===== GLOBALS ===== */
const tracks=[];                     
let playhead=0, zoom=1, isPlaying=false, loop=false, masterGain, masterReverb, masterDelay, masterComp;
const ctx=new (window.AudioContext||window.webkitAudioContext)();
masterGain=ctx.createGain(); masterComp=ctx.createDynamicsCompressor(); masterComp.threshold.value=-24; masterComp.knee.value=40; masterComp.ratio.value=12; masterComp.attack.value=0; masterComp.release.value=0.25;
masterReverb=ctx.createConvolver(); masterDelay=ctx.createDelay();
masterGain.connect(masterComp); masterComp.connect(masterReverb); masterReverb.connect(masterDelay); masterDelay.connect(ctx.destination);

let clipboard=null; const undoStack=[];

function status(msg){document.getElementById("status").innerText=msg;}
function addHistory(msg){document.getElementById("history").innerHTML+=msg+"<br>";}

/* ===== UNLOCK SCREEN ===== */
const unlockScreen=document.getElementById("unlockScreen");
const unlockBtn=document.getElementById("unlockBtn");
const unlockInput=document.getElementById("unlockInput");
const unlockDrop=document.getElementById("unlockDrop");

unlockBtn.onclick = async () => { await ctx.resume(); unlockInput.click(); };
unlockDrop.onclick = () => unlockInput.click();
unlockDrop.ondragover = e=>{ e.preventDefault(); unlockDrop.style.borderColor="#4ecdc4"; };
unlockDrop.ondrop = async e=>{ e.preventDefault(); unlockDrop.style.borderColor="#555"; await addFiles([...e.dataTransfer.files]); };

unlockInput.onchange = async e => { await addFiles([...e.target.files]); };

/* ===== FILE DROP (DAW) ===== */
const dropZone=document.getElementById("dropZone");
const fileInput=document.getElementById("fileInput");
dropZone.onclick=()=>fileInput.click();
dropZone.ondragover=e=>{e.preventDefault(); dropZone.style.borderColor="#4ecdc4";};
dropZone.ondrop=async e=>{e.preventDefault(); dropZone.style.borderColor="#444"; await addFiles([...e.dataTransfer.files]);};
fileInput.onchange=async e=>await addFiles([...e.target.files]);

/* ===== ADD FILES ===== */
async function addFiles(files){
  for(const f of files){
    const buf=await f.arrayBuffer();
    if(f.name.endsWith(".mid")||f.name.endsWith(".midi")){
      const notes=await midiToNotes(buf);
      const id=Date.now()+Math.random();
      tracks.push({name:f.name,buffer:null,gain:ctx.createGain(),pan:ctx.createStereoPanner(),mute:false,solo:false,id,clips:[],type:"midi",notes});
      createMidiLane(id);
    }else{
      const audioBuf=await ctx.decodeAudioData(buf);
      const id=Date.now()+Math.random();
      tracks.push({name:f.name,buffer:audioBuf,gain:ctx.createGain(),pan:ctx.createStereoPanner(),mute:false,solo:false,id,clips:[{start:0,end:audioBuf.duration,buffer:audioBuf}],type:"audio"});
      createTrackLane(id);
    }
    addHistory(`Added: ${f.name}`);
  }
  renderRuler();
  status(`${tracks.length} file(s) loaded`);
  if(unlockScreen.style.display!=="none"){
    unlockScreen.style.display="none";
    document.getElementById("dawPage").style.display="flex";
  }
}

async function midiToNotes(buf){return [{pitch:60,velocity:100,start:0,end:0.5},{pitch:64,velocity:90,start:0.5,end:1},{pitch:67,velocity:80,start:1,end:1.5}];}

/* ===== PLAYBACK ===== */
let playInterval;
function playAll(){ if(isPlaying)return; isPlaying=true; playInterval=setInterval(()=>{playhead+=0.01; updatePlayhead(); if(loop && playhead>getMaxDur()) playhead=0;},10); tracks.forEach(playTrack); status("Playing");}
function stopAll(){ isPlaying=false; clearInterval(playInterval); tracks.forEach(t=>{if(t.source) t.source.stop();}); playhead=0; updatePlayhead(); status("Stopped");}
function updatePlayhead(){const ruler=document.getElementById("ruler"); const left=(playhead/getMaxDur())*ruler.offsetWidth; document.getElementById("playhead").style.left=left+"px";}
function getMaxDur(){return tracks.reduce((max,t)=>{if(t.type==="audio") return Math.max(max,...t.clips.map(c=>c.end)); if(t.type==="midi") return Math.max(max,...t.notes.map(n=>n.end)); return max;},0)||1;}
function loopToggle(){loop=!loop; status(loop?"Loop ON":"Loop OFF");}
function playTrack(t){
  if(t.type==="audio" && t.buffer){
    t.source=ctx.createBufferSource();
    t.source.buffer=t.buffer;
    t.source.connect(t.gain); t.gain.connect(t.pan); t.pan.connect(masterGain);
    t.source.start(ctx.currentTime,playhead);
  }
}

/* ===== UI ===== */
function renderRuler(){
  const ruler=document.getElementById("ruler");
  ruler.innerHTML="";
  const dur=getMaxDur();
  for(let i=0;i<=dur;i++){
    const tick=document.createElement("div");
    tick.style.position="absolute";
    tick.style.left=(i/dur)*ruler.offsetWidth+"px";
    tick.style.top="0";
    tick.style.width="1px";
    tick.style.height="100%";
    tick.style.background="#444";
    tick.innerHTML=`<span style="margin-left:2px">${i}s</span>`;
    ruler.appendChild(tick);
  }
}
function createTrackLane(id){
  const lane=document.createElement("div");
  lane.className="track-lane";
  lane.id="lane_"+id;
  lane.innerHTML=`<canvas class="wave-canvas"></canvas>`;
  document.getElementById("timeline").appendChild(lane);
}
function createMidiLane(id){
  const lane=document.createElement("div");
  lane.className="track-lane";
  lane.id="lane_"+id;
  lane.innerHTML=`<canvas class="midi-canvas"></canvas>`;
  document.getElementById("timeline").appendChild(lane);
}

/* ===== STUBS ===== */
function splitAtPlayhead(){}
function copyClip(){}
function pasteClip(){}
function deleteClip(){}
function zoomIn(){}
function zoomOut(){}
function exportMix(){}
function aiBeatGen(){}
function aiVocalClean(){}
function aiAlignVocals(){}
function aiWriteLyrics(){}
function addMidiTrack(){}
function addLoop(){}
function sendChat(){}
function undoLast(){}

/* ===== REVERB IMPULSE ===== */
function buildImpulse(){
  const len=ctx.sampleRate*2;
  const impulse=ctx.createBuffer(2,len,ctx.sampleRate);
  for(let c=0;c<2;c++){
    const chan=impulse.getChannelData(c);
    for(let i=0;i<len;i++) chan[i]=(Math.random()*2-1)*Math.pow(1-i/len,2);
  }
  masterReverb.buffer=impulse;
}

/* ===== INIT ===== */
window.onload=()=>{addHistory("App ready"); status("Press Unlock & Upload to begin"); buildImpulse();};
</script>

</body>
</html>
