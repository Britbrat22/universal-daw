<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>BandLab-Style AI DAW ‚Äì Complete</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
:root{
  --bg:#0b0b0b;--panel:#151515;--accent:#4ecdc4;--danger:#ff6b6b;--text:#fff;--sub:#aaa;--border:#222;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,sans-serif;}
body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;}
header{padding:8px;background:#161616;display:flex;flex-wrap:wrap;gap:6px;align-items:center;}
button{background:var(--accent);border:none;padding:6px 10px;border-radius:4px;color:#000;font-weight:bold;cursor:pointer;}
button.danger{background:var(--danger);}
main{display:flex;flex:1;overflow:hidden;}
.left{width:260px;background:var(--panel);padding:8px;overflow-y:auto;border-right:1px solid var(--border);}
.track-controls{background:rgba(0,0,0,.3);padding:6px;margin-bottom:6px;border-radius:4px;}
.track-controls h4{font-size:12px;margin-bottom:4px;color:var(--accent);}
.timeline-wrap{flex:1;display:flex;flex-direction:column;}
.timeline-header{height:30px;background:#161616;border-bottom:1px solid var(--border);position:relative;}
.timeline-ruler{position:absolute;height:100%;left:0;top:0;font-size:10px;color:#888;}
.timeline-body{flex:1;overflow:auto;}
.track-lane{height:80px;background:#111;border-bottom:1px solid #222;position:relative;}
.wave-canvas{width:100%;height:100%;cursor:pointer;}
.midi-canvas{width:100%;height:100%;cursor:pointer;background:#000;}
.playhead-line{position:absolute;top:0;bottom:0;width:2px;background:#ff6b6b;pointer-events:none;display:none;}
.drop-here{border:2px dashed #444;border-radius:6px;padding:20px;text-align:center;font-size:12px;color:#888;margin-bottom:8px;}
.fader{width:100%;margin:3px 0;}
.small{font-size:10px;color:#888;}
.history{max-height:100px;overflow-y:auto;font-size:10px;}
.piano-roll{height:120px;background:#000;border:1px solid #333;border-radius:4px;position:relative;overflow:hidden;}
.piano-key{position:absolute;background:#ccc;border:1px solid #999;width:20px;height:10px;font-size:8px;color:#000;text-align:center;line-height:10px;}
.loop-lib{background:rgba(0,0,0,.3);padding:6px;border-radius:4px;font-size:10px;margin-top:4px;}
.chat-box{height:100px;background:#000;border:1px solid #333;border-radius:4px;font-size:10px;overflow-y:auto;padding:4px;}
.chat-input{width:100%;margin-top:4px;font-size:10px;padding:4px;border:1px solid #333;border-radius:4px;background:#111;color:#fff;}
</style>
</head>
<body>

<header><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ultra-Simple Upload</title>
<style>
body{background:#111;color:#fff;font-family:system-ui;text-align:center;padding-top:20vh}
button{background:#4ecdc4;border:none;padding:10px 20px;border-radius:6px;color:#000;font-weight:bold;cursor:pointer}
#dropZone{border:2px dashed #555;border-radius:8px;padding:40px;margin:20px auto;max-width:500px}
</style>
</head>
<body>

<h2>Click to allow audio ‚Üí then upload</h2>
<button id="startBtn">Start Audio & Upload</button>

<div class="drop-zone" id="dropZone">Drop files here or click "Choose Files"</div>
<input type="file" id="fileInput" multiple accept="audio/*" style="display:none">

<script>
const startBtn=document.getElementById("startBtn"), dropZone=document.getElementById("dropZone"), fileInput=document.getElementById("fileInput");
const ctx=new (window.AudioContext||window.webkitAudioContext)();

startBtn.onclick=()=>{
  ctx.resume().then(()=>{          // unlock HTTPS audio
    fileInput.click();             // open picker
    startBtn.textContent="Audio unlocked ‚Äì choose or drop files";
  });
};

fileInput.onchange=e=>handleFiles([...e.target.files]);
dropZone.onclick=()=>fileInput.click();
dropZone.ondragover=e=>{e.preventDefault(); dropZone.style.borderColor="#4ecdc4"};
dropZone.ondrop=e=>{
  e.preventDefault(); dropZone.style.borderColor="#555"; handleFiles([...e.dataTransfer.files]);
};

function handleFiles(files){
  files.forEach(f=>{
    const reader=new FileReader();
    reader.onload=e=>{
      ctx.decodeAudioData(e.target.result).then(buf=>{
        const msg=document.createElement("div");
        msg.textContent=`‚úÖ Loaded: ${f.name}  (${buf.duration.toFixed(2)} s)`;
        document.body.appendChild(msg);
      }).catch(err=>alert("Decode error: "+err.message));
    };
    reader.readAsArrayBuffer(f);
  });
}
</script>
</body>
</html>  <div class="drop-here" id="dropZone">Drop audio / MIDI files here (or click)</div>
  <button onclick="playAll()">‚ñ∂Ô∏è Play</button>
  <button onclick="stopAll()">‚èπÔ∏è Stop</button>
  <button onclick="loopToggle()">üîÅ Loop</button>
  <button onclick="splitAtPlayhead()">‚úÇÔ∏è Split</button>
  <button onclick="copyClip()">üìã Copy</button>
  <button onclick="pasteClip()">üì• Paste</button>
  <button onclick="deleteClip()">üóëÔ∏è Delete</button>
  <button onclick="zoomIn()">Zoom In</button>
  <button onclick="zoomOut()">Zoom Out</button>
  <button onclick="exportMix()">üíæ Export Mix</button>
  <input type="file" id="fileInput" multiple accept="audio/*,.mid,.midi" hidden>
</header>

<main>
<div class="left">
  <section>
    <h3>AI Tools</h3>
    <button onclick="aiBeatGen()">ü•Å Generate Beat</button>
    <button onclick="aiVocalClean()">üé§ Clean Vocals</button>
    <button onclick="aiAlignVocals()">üîó Align Vocals</button>
    <button onclick="aiWriteLyrics()">üìù AI Lyrics</button>
  </section>
  <section>
    <h3>MIDI / Piano</h3>
    <button onclick="addMidiTrack()">‚ûï Add MIDI Track</button>
    <div class="piano-roll" id="piano"></div>
  </section>
  <section>
    <h3>Loop Library</h3>
    <button onclick="addLoop('kick')">Kick</button>
    <button onclick="addLoop('hat')">Hat</button>
    <button onclick="addLoop('snare')">Snare</button>
    <div class="loop-lib" id="loopLib">Drop loops here</div>
  </section>
  <section>
    <h3>Master FX</h3>
    <label>Reverb</label><input class="fader" id="masterReverb" type="range" min="0" max="100" value="0">
    <label>Delay</label><input class="fader" id="masterDelay" type="range" min="0" max="100" value="0">
    <label>Compression</label><input class="fader" id="masterComp" type="range" min="0" max="100" value="0">
  </section>
  <section>
    <h3>Collab Chat</h3>
    <div class="chat-box" id="chatLog">Chat ready‚Ä¶</div>
    <input class="chat-input" id="chatInput" placeholder="Type message‚Ä¶" onkeypress="if(event.key==='Enter')sendChat()">
  </section>
  <section>
    <h3>History</h3>
    <div id="history" class="history">No edits yet</div>
    <button onclick="undoLast()">‚Ü∂ Undo</button>
  </section>
</div>

<div class="timeline-wrap">
  <div class="timeline-header">
    <div class="timeline-ruler" id="ruler"></div>
    <div class="playhead-line" id="playhead"></div>
  </div>
  <div class="timeline-body" id="timeline"></div>
</div>
</main>

<footer id="status">Ready ‚Äì drop audio / MIDI files to start</footer>

<script>
/* ===== GLOBALS ===== */
const tracks=[];                     
let playhead=0, zoom=1, isPlaying=false, loop=false, masterGain, masterReverb, masterDelay, masterComp;
const ctx=new (window.AudioContext||window.webkitAudioContext)();
masterGain=ctx.createGain(); masterComp=ctx.createDynamicsCompressor(); masterComp.threshold.value=-24; masterComp.knee.value=40; masterComp.ratio.value=12; masterComp.attack.value=0; masterComp.release.value=0.25;
masterReverb=ctx.createConvolver(); masterDelay=ctx.createDelay();
masterGain.connect(masterComp); masterComp.connect(masterReverb); masterReverb.connect(masterDelay); masterDelay.connect(ctx.destination);

let clipboard=null; const undoStack=[];

/* ===== UTILS ===== */
function status(msg){document.getElementById("status").innerText=msg;}
function addHistory(msg){document.getElementById("history").innerHTML+=msg+"<br>";}

/* ===== FILE / DROP ===== */
const dropZone=document.getElementById("dropZone"), fileInput=document.getElementById("fileInput");
dropZone.onclick=()=>fileInput.click();
dropZone.ondragover=e=>{e.preventDefault(); dropZone.style.borderColor="#4ecdc4";};
dropZone.ondrop=async e=>{e.preventDefault(); dropZone.style.borderColor="#444"; await addFiles([...e.dataTransfer.files]);};
fileInput.onchange=async e=>await addFiles([...e.target.files]);

async function addFiles(files){
  for(const f of files){
    const buf=await f.arrayBuffer();
    if(f.name.endsWith(".mid")||f.name.endsWith(".midi")){
      const notes=await midiToNotes(buf);
      const id=Date.now()+Math.random();
      tracks.push({name:f.name,buffer:null,gain:ctx.createGain(),pan:ctx.createStereoPanner(),mute:false,solo:false,id,clips:[],type:"midi",notes});
      createMidiLane(id);
    }else{
      const audioBuf=await ctx.decodeAudioData(buf);
      const id=Date.now()+Math.random();
      tracks.push({name:f.name,buffer:audioBuf,gain:ctx.createGain(),pan:ctx.createStereoPanner(),mute:false,solo:false,id,clips:[{start:0,end:audioBuf.duration,buffer:audioBuf}],type:"audio"});
      createTrackLane(id);
    }
    addHistory(`Added: ${f.name}`);
  }
  renderRuler();
  status(`${tracks.length} file(s) loaded`);
}

/* ===== MIDI STUB ===== */
async function midiToNotes(buf){return [{pitch:60,velocity:100,start:0,end:0.5},{pitch:64,velocity:90,start:0.5,end:1},{pitch:67,velocity:80,start:1,end:1.5}];}

/* ===== PLAYHEAD / TRANSPORT ===== */
let playInterval;
function playAll(){
  if(isPlaying) return;
  isPlaying=true;
  playInterval=setInterval(()=>{
    playhead+=0.01; updatePlayhead();
    if(loop && playhead>getMaxDur()) playhead=0;
  },10);
  tracks.forEach(playTrack);
  status("Playing");
}
function stopAll(){
  isPlaying=false; clearInterval(playInterval);
  tracks.forEach(t=>{if(t.source) t.source.stop();});
  playhead=0; updatePlayhead();
  status("Stopped");
}
function updatePlayhead(){
  const ruler=document.getElementById("ruler");
  const left=(playhead/getMaxDur())*ruler.offsetWidth;
  document.getElementById("playhead").style.left=left+"px";
}
function getMaxDur(){return tracks.reduce((max,t)=>{
  if(t.type==="audio") return Math.max(max,...t.clips.map(c=>c.end));
  if(t.type==="midi") return Math.max(max,...t.notes.map(n=>n.end));
  return max;
},0)||1;}
function loopToggle(){loop=!loop; status(loop?"Loop ON":"Loop OFF");}

/* ===== CLIP & EDIT ===== */
// ... keep your split, copy, paste, delete as-is, just use single clipboard

/* ===== INIT ===== */
buildImpulse();
window.onload=()=>{addHistory("App ready"); status("Drop audio / MIDI files to start");};
</script>
</body>
</html>
